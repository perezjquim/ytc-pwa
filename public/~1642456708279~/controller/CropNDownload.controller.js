sap.ui.define(["./util/BaseController"],function(t){"use strict";return t.extend("com.perezjquim.ytc.pwa.controller.CropNDownload",{API_BASE_URL:"https://perezjquim-ytc.herokuapp.com",onPressDownload:async function(){this.setBusy(true);const t=this.getModel("prompt");const e=t.getProperty("/split");var o=[];try{const s=decodeURIComponent(t.getProperty("/url"));const i=t.getProperty("/start_time");const c=t.getProperty("/end_time");if(e){const e=new Date(`1970-01-01 00:${i}`);const a=new Date(`1970-01-01 00:${c}`);const r=t.getProperty("/split_interval");const d=new Date(`1970-01-01 00:${r}`);const l=Number(d.getMinutes());const u=Number(d.getSeconds());while(true){const t=`${e.getMinutes()}:${e.getSeconds()}`;e.setMinutes(e.getMinutes()+l);e.setSeconds(e.getSeconds()+u);var n="";if(e.getTime()<=a.getTime()){n=`${e.getMinutes()}:${e.getSeconds()}`;o.push(await this._downloadVideo(s,t,n))}else{n=`${a.getMinutes()}:${a.getSeconds()}`;o.push(await this._downloadVideo(s,t,n));break}}}else{o.push(await this._downloadVideo(s,i,c))}const a=await Promise.all(o);a.forEach(async function(t){if(t.ok){const e=t.headers.get("content-disposition").split("filename=")[1].split(";")[0];const o=await t.blob();const n=new Blob([o],{type:"application/octet-stream"});if(window.navigator.msSaveBlob){window.navigator.msSaveBlob(n,e)}else{const t=window.URL.createObjectURL(n);const o=document.createElement("a");o.setAttribute("href",t);o.setAttribute("download",e);o.click()}}else{throw new Error("Response NOK")}});this.setBusy(false)}catch(t){this.setBusy(false);console.warn(t);this.toast(t)}},onUrlChanged:async function(){const t=this.getModel("prompt");const e=decodeURIComponent(t.getProperty("/url"));if(e){const t=this.getModel("misc");t.setProperty("/is_fetching_video_info",true);const o=(new Date).getTime();const n=`${this.API_BASE_URL}/get-video-info?url=${e}&=${o}`;try{const t=await fetch(n);const e=this.getModel("video_info");if(t.ok){const o=await t.json();e.setData(o)}else{e.setData({})}}catch(t){console.warn(t)}t.setProperty("/is_fetching_video_info",false)}},_downloadVideo:function(t,e,o){const n=(new Date).getTime();const s={url:t,start_time:e,end_time:o};const i=new URLSearchParams(s);const c=decodeURIComponent(i.toString());const a=`${this.API_BASE_URL}/crop-video?${c}&=${n}`;return fetch(a)}})});