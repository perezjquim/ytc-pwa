sap.ui.define(["./util/BaseController"],function(t){"use strict";return t.extend("com.perezjquim.ytc.pwa.controller.CropNDownload",{API_BASE_URL:"https://perezjquim-ytc.herokuapp.com",onPrepareVideo:async function(){this.setBusy(true);const t=this.getModel("prompt");const e=t.getProperty("/split");var o=[];try{const i=decodeURIComponent(t.getProperty("/url"));const c=t.getProperty("/start_time");const a=t.getProperty("/end_time");if(e){const e=new Date(`1970-01-01 00:${c}`);const n=new Date(`1970-01-01 00:${a}`);const r=t.getProperty("/split_interval");const d=new Date(`1970-01-01 00:${r}`);const l=Number(d.getMinutes());const u=Number(d.getSeconds());while(true){const t=`${e.getMinutes()}:${e.getSeconds()}`;e.setMinutes(e.getMinutes()+l);e.setSeconds(e.getSeconds()+u);var s="";if(e.getTime()<n.getTime()){s=`${e.getMinutes()}:${e.getSeconds()}`;o.push(await this._downloadVideo(i,t,s))}else{s=`${n.getMinutes()}:${n.getSeconds()}`;o.push(await this._downloadVideo(i,t,s));break}}}else{o.push(await this._downloadVideo(i,c,a))}const r=await Promise.all(o);const d=this.getModel("video_blobs");var n=[];r.forEach(async function(t){if(t.ok){const e=t.headers.get("content-disposition").split("filename=")[1].split(";")[0];const o=await t.blob();const s=new Blob([o],{type:"application/octet-stream"});const i=window.URL.createObjectURL(s);n=n.concat([{file_name:e,blob_url:i}]);d.setData(n)}});this.setBusy(false)}catch(t){this.setBusy(false);console.warn(t);this.toast(t)}},onParamChanged:async function(t){const e=this.byId("ytc-wizard");e.previousStep();const o=this.getModel("video_blobs");o.setData([]);const s=t.getSource();const n=s.getBinding("value")||s.getBinding("selected");const i=n.getPath();switch(i){case"/url":const t=this.getModel("prompt");const e=decodeURIComponent(t.getProperty("/url"));const o=this.getModel("video_info");if(e){const t=this.getModel("misc");t.setProperty("/is_fetching_video_info",true);const s=(new Date).getTime();const n=`${this.API_BASE_URL}/get-video-info?url=${e}&=${s}`;try{const t=await fetch(n);if(t.ok){const e=await t.json();o.setData(e);var c=e.duration;if(c.length>5){c=c.substr(c.length-5)}const s=this.getModel("prompt");s.setProperty("/end_time",c)}else{o.setData({})}}catch(t){console.warn(t);o.setData({})}t.setProperty("/is_fetching_video_info",false)}else{o.setData({})}break;default:break}},onPressDownload:function(t){const e=t.getSource();const o=e.getBindingContext("video_blobs");const s=o.getProperty("file_name");const n=o.getProperty("blob_url");const i=document.createElement("a");i.setAttribute("href",n);i.setAttribute("download",s);i.click()},_downloadVideo:function(t,e,o){const s=(new Date).getTime();const n={url:t,start_time:e,end_time:o};const i=new URLSearchParams(n);const c=decodeURIComponent(i.toString());const a=`${this.API_BASE_URL}/crop-video?${c}&=${s}`;return fetch(a)}})});