sap.ui.define(["./util/BaseController"],function(t){"use strict";return t.extend("com.perezjquim.ytc.pwa.controller.CropNDownload",{API_BASE_URL:"https://perezjquim-ytc.herokuapp.com",onPrepareVideo:async function(){this.setBusy(true);const t=this.getModel("prompt");const e=t.getProperty("/split");var o=[];try{const i=decodeURIComponent(t.getProperty("/url"));const c=t.getProperty("/start_time");const a=t.getProperty("/end_time");if(e){const e=new Date(`1970-01-01 00:${c}`);const s=new Date(`1970-01-01 00:${a}`);const r=t.getProperty("/split_interval");const l=new Date(`1970-01-01 00:${r}`);const d=Number(l.getMinutes());const g=Number(l.getSeconds());while(true){const t=`${e.getMinutes()}:${e.getSeconds()}`;e.setMinutes(e.getMinutes()+d);e.setSeconds(e.getSeconds()+g);var n="";if(e.getTime()<s.getTime()){n=`${e.getMinutes()}:${e.getSeconds()}`;o.push(await this._downloadVideo(i,t,n))}else{n=`${s.getMinutes()}:${s.getSeconds()}`;o.push(await this._downloadVideo(i,t,n));break}}}else{o.push(await this._downloadVideo(i,c,a))}const r=await Promise.all(o);const l=this.getModel("video_blobs");var s=[];r.forEach(async function(t){if(t.ok){const e=t.headers.get("content-disposition").split("filename=")[1].split(";")[0];const o=await t.blob();const n=new Blob([o],{type:"application/octet-stream"});const i=window.URL.createObjectURL(n);s=s.concat([{file_name:e,blob_url:i}]);s.sort((t,e)=>t["file_name"]>e["file_name"]?1:-1);l.setData(s)}else{const e=await t.text();console.warn(e);this.toast(e)}}.bind(this))}catch(t){console.warn(t);this.toast(t)}this.setBusy(false)},onParamChanged:async function(t){const e=this.byId("ytc-wizard");e.previousStep();const o=this.getModel("video_blobs");o.setData([]);const n=t.getSource();const s=n.getBinding("value")||n.getBinding("selected");const i=s.getPath();switch(i){case"/url":const t=this.getModel("prompt");const e=decodeURIComponent(t.getProperty("/url"));const o=this.getModel("video_info");if(e){const n=this.getModel("misc");n.setProperty("/is_fetching_video_info",true);const s=(new Date).getTime();const i=`${this.API_BASE_URL}/get-video-info?url=${e}&=${s}`;try{const e=await fetch(i);if(e.ok){const n=await e.json();o.setData(n);if(!t.getProperty("/end_time")){var c=n.duration;if(c.length>5){c=c.substr(c.length-5)}const t=this.getModel("prompt");t.setProperty("/end_time",c)}}else{o.setData({});const t=await e.text();console.warn(t);this.toast(t)}}catch(t){console.warn(t);o.setData({})}n.setProperty("/is_fetching_video_info",false)}else{o.setData({})}break;default:break}},onPressDownload:function(t){const e=t.getSource();const o=e.getBindingContext("video_blobs");const n=o.getProperty("file_name");const s=o.getProperty("blob_url");const i=document.createElement("a");i.setAttribute("href",s);i.setAttribute("download",n);i.click()},_downloadVideo:async function(t,e,o){const n=(new Date).getTime();const s={url:t,start_time:e,end_time:o};const i=new URLSearchParams(s);const c=decodeURIComponent(i.toString());const a=`${this.API_BASE_URL}/crop-video?${c}&=${n}`;return fetch(a)}})});